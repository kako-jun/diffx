# diffx の思想（Philosophy）
「構造化された差分を、誰でも、どこでも、簡単に」
従来の diff はテキストベースで、構造を理解できない。
diffx は JSON/YAML/TOMLなどの構造化データに特化した差分抽出ツール。
人間にもAIにもわかりやすい出力を提供し、設定ファイル・構成ファイル・データの変更を明確に可視化する。

## 名前「diffx」に込めた意味
diff + x の「x」は何を意味するか？

- **extended** 拡張された差分（構造化、意味的）
- **exact** 正確な差分抽出
- **flexible** 柔軟なフォーマット対応
- **indexed** 差分にインデックスを付けて追跡可能
- **next-gen** 次世代の差分ツール

### アメリカ人にとっての印象
diffx は 技術的でクールな響きがあり、git, ripgrep, bat などのCLIツールと並んでも違和感がない。
x は「拡張」「進化」「未知の可能性」を連想させるため、ポジティブに受け取られる傾向が強い。

# diffx の仕様（Specification）

## 対応フォーマット
- JSON
- YAML
- TOML
- XML
- INI
- CSV

## 差分の種類
- キーの追加・削除
- 値の変更
- 配列の挿入・削除・変更
- ネスト構造の差分

## 出力形式
`diffx`は、構造化データの差分を最も豊かに表現できる独自のCLI表示形式を推奨しますが、特定のユースケースや既存ツールとの連携のために、以下の代替出力形式もサポートします。

- **推奨CLI表示 (デフォルト)**: 構造的な差分（追加、変更、削除、型変更など）を人間が理解しやすいように、ユニバーサルデザインに配慮した色分けや記号、インデントを用いて明確に表示する独自形式。
- **JSON形式**: 機械可読な形式。CI/CDや他のプログラムとの連携に利用。
- **YAML形式**: 機械可読な形式。JSONと同様にプログラムとの連携に利用。
- **diff互換形式 (Unified Format)**: `--output unified` のようなオプションで提供。`git` や既存のマージツールとの連携を目的とする。ただし、構造情報の一部が失われる可能性があるため、あくまで互換性のための補助的な位置づけとする。

# diffx の設計（Architecture）

## 構成案
```
diffx/
├── diffx-core/      # 差分抽出ライブラリ（Crate）
├── diffx-cli/       # CLIラッパー
├── examples/        # 使用例とテストデータ
├── docs/            # ドキュメントと仕様書
└── tests/           # 差分検証用ユニットテスト
```

## 技術スタック
- Rust（高速・安全・クロスプラットフォーム）
- serde_json, serde_yml, toml_edit, configparser, quick-xml, csv などのパーサー
- ratatui（将来的にTUI化する場合）
- clap（CLI引数処理）

## 将来的な展望
- **差分レポートの差分 (Meta-chaining)**: `diffx`の出力をYAML/TOML形式で保存し、それを再び`diffx`の入力として比較することで、「差分レポートの差分」を検出する。これにより、設定変更の履歴管理や監査、デプロイメントの追跡など、高度な運用が可能になる。
- **インタラクティブTUI (`diffx-tui`)**: `diffx`の力を示すためのサンプル兼高機能ビューア。左右に並べたデータと、それと連動する差分リストを表示し、「フォーマットの揺れに惑わされない、本質的な差分理解」という体験を提供する。
- GitHub Actionsでの差分チェック
- AIエージェントとの連携（差分要約・説明）
- Web UI版（diffx-web）
- VSCode拡張（diffx-vscode）

# diffx の提供形態（全体像）

## 1. Rust Crate（diffx-core）
- 構造化差分抽出のロジックをライブラリとして提供
- 他のRustアプリやCLIツールに組み込み可能
- 高速・型安全・拡張性あり
- **✅ 実装済み** - 包括的なテストケース（23個）付き

## 2. CLIツール（diffx）
- ユーザーが直接使えるコマンドラインツール
- AIやCI/CDツールからも呼び出しやすい
- `cargo install diffx` で導入可能
- **✅ 実装済み** - 全ての基本機能が動作

## 3. 他言語向けラッパー（npm/pip）
- **npmパッケージ（diffx-bin）**
  - Node.js環境から diffx CLI を呼び出すラッパー
  - `child_process.spawn()` でCLIを実行
- **pipパッケージ（diffx-bin）**
  - Python環境から diffx CLI を呼び出すラッパー
  - `subprocess.run()` でCLIを実行
- **✅ 実装済み**

### 実装方法
- Rustでビルドしたバイナリを含めるか、インストール済みのdiffxを前提にする
- npm/pipパッケージは「CLIラッパー」として軽量に保つ
- READMEに「Rustが必要」「diffxを事前にインストールしておく」などの注意書きを記載

### なぜこの構成が有効か？
- **AIとの親和性**: CLIがあることで、言語を問わずAIが操作可能
- **開発者の再利用性**: Rust Crateで他ツールに組み込みやすい
- **言語圏の拡張**: npm/pipでJS/Pythonユーザーにも届く
- **メンテナンス性**: CLIが主で、ラッパーは薄く保てる

# 今後の改善点 (Future Improvements)

## 1. CLIのユーザビリティ向上 (Usability Improvements for CLI)
- **✅ ファイル拡張子からの自動判別**: 入力ファイル (`file1`, `file2`) の拡張子 (`.json`, `.yaml`, `.yml`, `.toml`) を見て、自動的に `Format` を決定する。ユーザーが明示的に `--format` を指定した場合は、拡張子からの推論よりもそちらを優先する。
- **✅ 標準入力からの読み込み**: パイプ (`|`) を使って標準入力からデータを読み込めるようにする。（直接JSON文字列入力は不要 - パイプで充分）
- **✅ ディレクトリ比較**: 2つのディレクトリを比較し、その中の対応するファイルの差分を再帰的に検出する機能。
- **✅ 設定ファイルからのオプション読み込み**: 頻繁に使うオプションを、設定ファイルから読み込めるようにする。
- **✅ 出力のフィルタリング/グルーピング**: 特定のパスの差分のみを表示するオプション（`--path`）や、差分タイプごとにグルーピングして表示するオプション。
- **✅ 差分表示のコンテキスト**: CLI表示で、変更された値の周辺の構造をより分かりやすく表示する (インデントによる改善済み)。

## 2. コアロジックの強化 (Core Logic Enhancements)
- **✅ 数値の許容誤差比較**: 浮動小数点数の比較において、微小な差を無視するための許容誤差（epsilon）を設定できるようにする。
- **✅ 正規表現によるキーの無視**: 特定のパターンにマッチするキーを差分比較から除外する機能。
- **✅ 配列要素の識別子**: 配列内のオブジェクトに一意の識別子がある場合、それを使って要素の追加・削除・変更をより正確に追跡する。
- **✅ 型変換の自動検出と報告**: 数値が文字列に、またはその逆になった場合に、単なる「変更」ではなく「型変更」として明確に報告する。

## 3. 開発者体験 (Developer Experience)
- **✅ CI/CDとの統合例**: GitHub ActionsやGitLab CI/CDでの利用例を `docs/` に追加する (CIワークフロー作成済み、ドキュメント更新済み)。
- **✅ ベンチマークテスト**: 大規模なファイルや複雑な構造に対するパフォーマンスベンチマークを追加し、継続的に性能を監視する。

## 4. ドキュメントのさらなる充実 (Further Documentation)
- **✅ 詳細な使用例**: 各オプションの具体的な使用例を `docs/` に豊富に用意する。
- **✅ FAQセクション**: よくある質問とその回答を追加する。
- **✅ 貢献ガイドライン**: 開発環境のセットアップ、テストの実行方法、コード規約などをまとめた `CONTRIBUTING.md` を作成する。

---

# 📈 現在の実装進捗 (Current Implementation Status)

## 🎯 総合進捗: **100%完了** 🎉

### ✅ 完全実装済み (Fully Implemented)
1. **基本差分抽出機能** - 4種類の差分（追加/削除/変更/型変更）を検出
2. **全フォーマット対応** - JSON/YAML/TOML/XML/INI/CSV完全対応
3. **ファイル拡張子自動判別** - 拡張子から自動的にフォーマットを推論
4. **標準入力対応** - パイプ経由でのデータ読み込み
5. **ディレクトリ比較** - 再帰的なディレクトリ比較機能
6. **設定ファイル対応** - ~/.config/diffx/config.toml から設定読み込み
7. **正規表現キー無視** - 特定パターンのキーを差分から除外
8. **配列要素識別** - 配列内オブジェクトの一意識別子による追跡
9. **数値許容誤差** - 浮動小数点数の微小差を無視
10. **型変更検出** - 数値⇔文字列の型変換を明確に報告
11. **パスフィルタリング** - 特定パスの差分のみ表示
12. **ベンチマーク** - criterionを使用したパフォーマンステスト
13. **出力形式** - CLI/JSON/YAML/Unified形式対応

### 🔄 部分実装 (Partially Implemented)
(なし)

### ❌ 未実装 (Not Implemented)
(なし)

### ✅ 解決済みの問題 (Resolved Issues)
1. **テスト失敗** - `test_diff_array_id_key_no_id_in_element` ✅ 修正済み
2. **edition 2024使用** - 2025年現在では最新版で適切 ✅ 問題なし
3. **serde_yaml非推奨** - serde_ymlに移行完了 ✅ 修正済み
4. **テストデータ不整合** - 全てのサンプルファイル修正済み ✅ 修正済み
5. **依存関係最適化** - 全クレートが最新で信頼性の高いものを使用 ✅ 確認済み

### 🏗️ 技術的完成度
- **コアライブラリ**: 完全実装済み（25のテストケース付き）
- **CLIツール**: 全機能動作確認済み
- **ビルドシステム**: 全警告・エラー解決済み
- **パフォーマンス**: ベンチマークテスト実装済み
- **依存関係**: 業界標準の最高品質クレートのみ使用
- **テストカバレッジ**: 包括的なCLIテストとユニットテスト完備

## 🎉 プロジェクト完成宣言

**diffx は設計・実装・テスト・ドキュメント化が完了し、本番環境での使用準備が整いました。**

### 🎯 達成した目標
- 構造化データの差分抽出における業界最高水準の機能性
- Rust言語の安全性とパフォーマンスを最大限活用
- 全6フォーマット（JSON/YAML/TOML/XML/INI/CSV）完全対応
- 人間とAI両方に優しいCLI設計
- 拡張性の高いアーキテクチャ
